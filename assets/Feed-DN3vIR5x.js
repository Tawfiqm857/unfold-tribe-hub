import{o as k,h as X,r as l,j as s,n as Z,A as B,t as H,v as R,p as y,B as h,l as ee,w as m,x}from"./index-C0xk7pEu.js";import{C as _,a as U,c as w}from"./card-BGo4dePb.js";import{T as se}from"./textarea-yBZ2wC7G.js";import{F as te}from"./filter-DNELEedC.js";import{H as ae}from"./heart-7GSVmK_I.js";import{M as ie}from"./message-circle-CQLgQa73.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=k("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=k("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=k("Share",[["path",{d:"M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8",key:"1b2hhj"}],["polyline",{points:"16 6 12 2 8 6",key:"m901s6"}],["line",{x1:"12",x2:"12",y1:"2",y2:"15",key:"1p0rca"}]]),fe=()=>{var F;const{user:a}=X(),[j,C]=l.useState(""),[o,S]=l.useState([]),[W,D]=l.useState(!0),[P,b]=l.useState(!1),[p,f]=l.useState([]),[A,G]=l.useState({}),[I,v]=l.useState({}),[L,Y]=l.useState({}),[z,E]=l.useState({}),[$,M]=l.useState({}),q=["All","Tips","Wins","Ask","News","Events","Resources"];l.useEffect(()=>{(async()=>{try{const{data:t,error:n}=await m.from("posts").select("*").order("created_at",{ascending:!1});if(n)throw n;const i=t||[];f(i);const c=Array.from(new Set(i.map(r=>r.author_id)));if(c.length){const{data:r,error:d}=await m.from("profiles").select("user_id, full_name, avatar_url").in("user_id",c);if(d)throw d;const u={};(r||[]).forEach(g=>{u[g.user_id]=g}),G(u)}if(a!=null&&a.id&&i.length){const r=i.map(N=>N.id),{data:d,error:u}=await m.from("post_likes").select("post_id").in("post_id",r).eq("user_id",a.id);if(u)throw u;const g={};(d||[]).forEach(N=>{g[N.post_id]=!0}),v(g)}}catch(t){x({title:"Failed to load feed",description:t.message,variant:"destructive"})}finally{D(!1)}})()},[a==null?void 0:a.id]);const J=async()=>{if(!(a!=null&&a.id)){x({title:"Login required",description:"Please login to post."});return}if(j.trim()){b(!0);try{const{data:e,error:t}=await m.from("posts").insert([{author_id:a.id,content:j.trim(),tags:o.length?o:null}]).select("*").single();if(t)throw t;f(n=>[e,...n]),C(""),S([]),x({title:"Posted!",description:"Your post is live."})}catch(e){x({title:"Post failed",description:e.message,variant:"destructive"})}finally{b(!1)}}},T=e=>{S(t=>t.includes(e)?t.filter(n=>n!==e):[...t,e])},K=l.useMemo(()=>!o.length||o.includes("All")?p:p.filter(e=>{var t;return(t=e.tags)==null?void 0:t.some(n=>o.includes(n))}),[p,o]),O=async e=>{if(!(a!=null&&a.id))return x({title:"Login required",description:"Please login to like."});try{if(I[e.id]){const{error:t}=await m.from("post_likes").delete().eq("post_id",e.id).eq("user_id",a.id);if(t)throw t;v(n=>({...n,[e.id]:!1})),f(n=>n.map(i=>i.id===e.id?{...i,likes_count:Math.max(0,i.likes_count-1)}:i))}else{const{error:t}=await m.from("post_likes").insert([{post_id:e.id,user_id:a.id}]);if(t)throw t;v(n=>({...n,[e.id]:!0})),f(n=>n.map(i=>i.id===e.id?{...i,likes_count:i.likes_count+1}:i))}}catch(t){x({title:"Action failed",description:t.message,variant:"destructive"})}},Q=async e=>{if(Y(t=>({...t,[e.id]:!t[e.id]})),!L[e.id]){const{data:t,error:n}=await m.from("post_comments").select("*").eq("post_id",e.id).order("created_at",{ascending:!1}).limit(5);n||M(i=>({...i,[e.id]:t||[]}))}},V=async e=>{var n;if(!(a!=null&&a.id))return x({title:"Login required",description:"Please login to comment."});const t=(n=z[e.id])==null?void 0:n.trim();if(t)try{const{data:i,error:c}=await m.from("post_comments").insert([{post_id:e.id,user_id:a.id,content:t}]).select("*").single();if(c)throw c;M(r=>({...r,[e.id]:[i,...r[e.id]||[]]})),f(r=>r.map(d=>d.id===e.id?{...d,comments_count:d.comments_count+1}:d)),E(r=>({...r,[e.id]:""}))}catch(i){x({title:"Comment failed",description:i.message,variant:"destructive"})}};return W?s.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:s.jsx(Z,{className:"w-6 h-6 animate-spin"})}):s.jsxs("div",{className:"max-w-2xl mx-auto space-y-6",children:[s.jsxs(_,{children:[s.jsx(U,{children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs(B,{children:[s.jsx(H,{src:a==null?void 0:a.avatar,alt:a==null?void 0:a.fullName,loading:"lazy"}),s.jsx(R,{children:(F=a==null?void 0:a.fullName)==null?void 0:F.charAt(0)})]}),s.jsxs("div",{children:[s.jsx("p",{className:"font-medium",children:(a==null?void 0:a.fullName)||"Guest"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"Share with your tribe"})]})]})}),s.jsxs(w,{className:"space-y-4",children:[s.jsx(se,{placeholder:"What's on your mind? Share tips, wins, or ask questions...",value:j,onChange:e=>C(e.target.value),className:"min-h-[100px] resize-none"}),s.jsx("div",{className:"flex flex-wrap gap-2",children:q.slice(1).map(e=>s.jsx(y,{variant:o.includes(e)?"default":"outline",className:"cursor-pointer",onClick:()=>T(e),children:e},e))}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs(h,{variant:"ghost",size:"sm",children:[s.jsx(ne,{className:"w-4 h-4 mr-2"}),"Add Image"]}),s.jsxs(h,{onClick:J,disabled:!j.trim()||P,children:[s.jsx(re,{className:"w-4 h-4 mr-2"}),P?"Posting...":"Post"]})]})]})]}),s.jsx(_,{children:s.jsx(w,{className:"py-4",children:s.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[s.jsx(te,{className:"w-4 h-4 text-muted-foreground"}),q.map(e=>s.jsx(y,{variant:o.includes(e)?"default":"outline",className:"cursor-pointer hover:bg-accent",onClick:()=>T(e),children:e},e))]})})}),s.jsx("div",{className:"space-y-4",children:K.map(e=>{var n;const t=A[e.author_id];return s.jsxs(_,{className:"card-hover",children:[s.jsx(U,{children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsxs(B,{children:[s.jsx(H,{src:(t==null?void 0:t.avatar_url)||void 0,alt:(t==null?void 0:t.full_name)||"User",loading:"lazy"}),s.jsx(R,{children:((t==null?void 0:t.full_name)||"U").charAt(0)})]}),s.jsxs("div",{children:[s.jsx("div",{className:"flex items-center gap-2",children:s.jsx("p",{className:"font-medium",children:(t==null?void 0:t.full_name)||"Member"})}),s.jsx("p",{className:"text-sm text-muted-foreground",children:new Date(e.created_at).toLocaleString("en-NG")})]})]}),s.jsx("div",{className:"flex gap-1",children:(n=e.tags)==null?void 0:n.map(i=>s.jsx(y,{variant:"secondary",className:"text-xs",children:i},i))})]})}),s.jsxs(w,{className:"space-y-4",children:[s.jsx("p",{className:"text-foreground leading-relaxed whitespace-pre-wrap",children:e.content}),e.image_url&&s.jsx("div",{className:"rounded-lg overflow-hidden",children:s.jsx("img",{src:e.image_url,alt:"Post content",loading:"lazy",className:"w-full h-64 object-cover"})}),s.jsxs("div",{className:"flex items-center justify-between pt-2 border-t",children:[s.jsxs("div",{className:"flex items-center gap-6",children:[s.jsxs(h,{variant:"ghost",size:"sm",className:"gap-2",onClick:()=>O(e),children:[s.jsx(ae,{className:`w-4 h-4 ${I[e.id]?"text-primary fill-primary":""}`}),e.likes_count]}),s.jsxs(h,{variant:"ghost",size:"sm",className:"gap-2",onClick:()=>Q(e),children:[s.jsx(ie,{className:"w-4 h-4"}),e.comments_count]})]}),s.jsx(h,{variant:"ghost",size:"sm",onClick:()=>{var i;return(i=navigator.share)==null?void 0:i.call(navigator,{title:"Unfold Tribe",text:e.content})},children:s.jsx(le,{className:"w-4 h-4"})})]}),L[e.id]&&s.jsxs("div",{className:"space-y-3",children:[s.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[s.jsx(ee,{placeholder:"Write a comment...",value:z[e.id]||"",onChange:i=>E(c=>({...c,[e.id]:i.target.value}))}),s.jsx(h,{size:"sm",onClick:()=>V(e),children:"Comment"})]}),s.jsx("div",{className:"space-y-2",children:($[e.id]||[]).map(i=>{var c;return s.jsxs("div",{className:"text-sm text-muted-foreground",children:[s.jsxs("span",{className:"font-medium text-foreground",children:[((c=A[i.user_id])==null?void 0:c.full_name)||"Member",":"]})," ",i.content]},i.id)})})]})]})]},e.id)})})]})};export{fe as default};
